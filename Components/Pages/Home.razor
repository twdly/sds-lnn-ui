@page "/"
@rendermode InteractiveServer
@using lnn_ui.Models
@using lnn_ui.Services

<PageTitle>Home</PageTitle>

<div class="container">
    <h1 class="main-title">Cyclone Detector</h1>

    @if (_prediction is { Nature: not 0 })
    {
        <div class="prediction-container">
            <div class="prediction-section">
                <h2 class="section-title">Current Predictions</h2>
                <div class="data-grid">
                    <div class="data-card @GetNatureClass()">
                        <div class="data-output">
                            <span class="data-label">Nature</span>
                            <i class="bi bi-search"></i>
                        </div>
                        <span class="data-value">@GetNatureDisplay()</span>
                    </div>
                    <div class="data-card">
                    <div class="data-output">
                        <span class="data-label">Intensity</span>
                        <i class="bi bi-speedometer2"></i>
                    </div>
                        <span class="data-value">@roundIntensity()%</span>
                    </div>
                </div>
            </div>

            <div class="prediction-section">
                <h2 class="section-title">Most Recent Data</h2>
                <div class="data-grid">
                    <div class="data-card">
                        <div class="data-output">
                            <span class="data-label">Gust</span>
                            <i class="bi bi-wind data-label"></i>
                        </div>
                        <span class="data-value">@_prediction.Gust km/h</span>
                    </div>
                    <div class="data-card">
                        <div class="data-output">
                            <span class="data-label">Eye</span>
                            <i class="bi bi-tropical-storm"></i>
                        </div>
                        <span class="data-value">@_prediction.Eye km</span>
                    </div>
                </div>
            </div>

            <div class="update-section">
                <p class="update-time">Data last updated: @_lastUpdated.ToString("f")</p>
                <button class="update-button" @onclick="Update">Update Now</button>
            </div>
        </div>
    }
    else
    {
        <div class="error-message">
            <svg xmlns="http://www.w3.org/2000/svg" class="error-icon" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            </svg>
            <p>Prediction data could not be loaded</p>
        </div>
    }
</div>



@code {
    [Inject] PredictionService? PredictionService { get; set; }
    LnnOutput? _prediction;
    DateTime _lastUpdated;
    
    protected override async Task OnInitializedAsync()
    {
        await Update();
    }

    private async Task Update()
    {
        _prediction = await PredictionService!.GetPrediction();
        _lastUpdated = DateTime.Now;
    }

    private RenderFragment GetNatureDisplay() => builder =>
    {
        string displayText = Math.Round(_prediction.Nature, 1) switch
        {
            >= 0 and < 0.5 => "Disturbance",
            >= 0.5 and < 0.9 => "Depression",
            >= 1 and < 1.5 => "Depression",
            >= 1.5 and < 1.9 => "Storm",
            >= 2 and < 2.5 => "Storm",
            >= 2.5 and < 2.9 => "Cyclone",
            >= 3 => "Cyclone",
            _ => "Something went wrong"
        };

        builder.AddContent(0, displayText);

        if (Math.Round(_prediction.Nature, 1) % 1 != 0)
        {
            builder.OpenElement(1, "i");
            builder.AddAttribute(2, "class", "bi bi-chevron-double-up transition");
            builder.CloseElement();
        }
    };

    private double roundIntensity() 
    {
        return Math.Round(_prediction.Intensity * 10, 0);
    }




    private string GetNatureClass()
    {
        return Math.Round(_prediction.Nature, 1) switch
        {
            >= 0 and < 0.5 => "dist",
            >= 0.5 and < 0.9 => "td",
            >= 1 and < 1.5 => "depr",
            >= 1.5 and < 1.9 => "ts",
            >= 2 and < 2.5 => "s",
            >= 2.5 and < 2.9 => "tc",
            >= 3 => "c",
            _ => "Something went wrong"
        };
    }
}